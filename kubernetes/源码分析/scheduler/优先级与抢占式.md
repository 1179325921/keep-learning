## 前言
当kube-scheduler调度器运行时，根据Pod资源对象的优先级进行调度，高优先级的Pod资源对象排在调度队列(SchedulingQueue)的前面，优先获得合适的节点(Node),然后为低优先级的Pod资源对象选择合适的节点

当高优先级的Pod资源对象没有找到合适的节点时，调度器会尝试抢占低优先级的Pod资源对象的节点，抢占的过程是将低优先及的Pod资源对象从所在节点上驱逐，事高优先级的Pod资源对象运行在该节点上，被驱逐的低优先级Pod资源对象会重新进入到调度队列并等待再次选择合适的节点

## kube-scheduler优先级与抢占机制的场景

![image](../images/优先级抢占.png)

SchedulingQueue调度队列中拥有高优先级(HighPriority),中优先级(MidPriority),低优先级(LowPriority)3个Pod资源对象，它们等待被调度。调度队列中的对象也被称作带调度Pod(Pending Pod)资源对象。

- 场景1：kube-scheduler调度其将待调度Pod资源对象按照优先级顺序调度到可用节点上
- 场景2：kube-scheduler调度器将待调度Pod资源对象按照优先级顺序调度到可用节点上。当调度Pod3资源对象时，可用节点没有可用资源运行Pod3。此时，Pod3在调度队列中处于待调度状态
- 场景3：kube-scheduler调度器将待调度Pod资源对象按照优先级顺序调度到可以节点上。可用节点上已调度了Pod2和Pod3资源对象，当调度Pod1时，可用节点上已经没有资源运行Pod1了，此时高优先级的Pod1将抢占低优先级的Pod3,而被抢占的Pod3重新进入调度队列等待再次选择合适的节点 

在默认情况下，若不启用优先级功能，则现有Pod资源对象的优先级都为0,可以通过PriorityClass对象设置优先级。
```yaml
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: high-priority
value: 100000
globalDefault: false
description: "This priority class should be used for XYZ service pods only"
```
value字段表示优先级，值越高优先级越高。注意:在k8s中，只能存在一个将globalDefault字段为true的PriorityClass。

为Pod设置优先级，在PodSpec中添加优先级对象的名称即可
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    env: test
spec:
  containers:
    - name: nginx
      image: nginx
      imagePullPolicy: IfNotPresent
  priorityClassName: high-priority
```